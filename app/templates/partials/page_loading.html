<style>
  /* 简易顶部加载进度条（页面跳转/加载时） */
  html.__page-loading::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    height: 2px;
    width: 100%;
    background: var(--primary, #22c55e);
    transform-origin: 0 50%;
    transform: scaleX(var(--page-progress, 0));
    opacity: 1;
    transition: transform 320ms ease, opacity 200ms ease;
    z-index: 9999;
    pointer-events: none;
  }

  html.__page-loading.__page-loading-fade::before {
    opacity: 0;
  }
</style>
<script>
  (function () {
    var root = document.documentElement;
    var startAt = 0;
    var progress = 0;
    var timers = [];

    var MIN_SHOW_MS = 260;
    var FINISH_TRANSITION_MS = 320;
    var NAV_TOTAL_MS = 1000;
    var CLEANUP_DELAY_MS = 520;

    function clearTimers() {
      for (var i = 0; i < timers.length; i++) {
        window.clearTimeout(timers[i]);
      }
      timers = [];
    }

    function start() {
      clearTimers();
      root.classList.remove('__page-loading-fade');
      root.classList.add('__page-loading');
      startAt = Date.now();
      progress = 0;
      setProgress(0.08);

      timers.push(window.setTimeout(function () { setProgress(0.55); }, 80));
      timers.push(window.setTimeout(function () { setProgress(0.8); }, 260));
      timers.push(window.setTimeout(function () { setProgress(0.93); }, 700));
      timers.push(window.setTimeout(function () { setProgress(0.96); }, 1800));
      timers.push(window.setTimeout(function () { setProgress(0.98); }, 4500));
    }

    function setProgress(value) {
      if (typeof value !== 'number' || !isFinite(value)) return;
      if (value < progress) return;
      progress = Math.max(0, Math.min(1, value));
      root.style.setProperty('--page-progress', String(progress));
    }

    function finish(opts) {
      opts = opts || {};
      var fade = opts.fade !== false;
      clearTimers();
      setProgress(1);

      if (fade) {
        timers.push(window.setTimeout(function () {
          root.classList.add('__page-loading-fade');
        }, 160));
      }

      timers.push(window.setTimeout(function () {
        root.classList.remove('__page-loading');
        root.classList.remove('__page-loading-fade');
        root.style.removeProperty('--page-progress');
      }, CLEANUP_DELAY_MS));
    }

    function stop() {
      if (!root.classList.contains('__page-loading')) return;
      var elapsed = Date.now() - startAt;
      var delay = elapsed < MIN_SHOW_MS ? (MIN_SHOW_MS - elapsed) : 0;
      timers.push(window.setTimeout(function () { finish({ fade: true }); }, delay));
    }

    function isSameOriginHttpUrl(url) {
      if (!url) return false;
      if (url.protocol !== 'http:' && url.protocol !== 'https:') return false;
      return url.origin === window.location.origin;
    }

    function navigateWithBar(url) {
      try { sessionStorage.setItem('__skip_initial_loading_bar', '1'); } catch (_) { }

      var completeAt = Math.max(0, NAV_TOTAL_MS - FINISH_TRANSITION_MS - 20);
      timers.push(window.setTimeout(function () { setProgress(1); }, completeAt));
      timers.push(window.setTimeout(function () { window.location.href = url; }, NAV_TOTAL_MS));
    }

    var skip = false;
    try {
      skip = sessionStorage.getItem('__skip_initial_loading_bar') === '1';
      if (skip) sessionStorage.removeItem('__skip_initial_loading_bar');
    } catch (_) {
      skip = false;
    }

    if (!skip) start();

    window.addEventListener('load', stop);
    window.addEventListener('pageshow', stop);
    window.setTimeout(stop, 12000);

    document.addEventListener('click', function (e) {
      if (e.defaultPrevented) return;
      if (e.button !== 0) return;
      if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;

      var a = e.target && e.target.closest ? e.target.closest('a[href]') : null;
      if (!a) return;
      if (a.target && a.target !== '_self') return;
      if (a.hasAttribute('download')) return;

      var href = a.getAttribute('href');
      if (!href || href.startsWith('#') || href.startsWith('javascript:')) return;

      var url = null;
      try { url = new URL(href, window.location.href); } catch (_) { return; }
      if (!isSameOriginHttpUrl(url)) return;

      e.preventDefault();
      start();
      navigateWithBar(url.href);
    });

    document.addEventListener('submit', function (e) {
      if (e.defaultPrevented) return;
      start();
    });
  })();
</script>
